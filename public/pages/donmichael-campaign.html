<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>DonMichael Campaign - Meauxbility</title>
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HZEWHZG1WP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-HZEWHZG1WP', {
      custom_map: {
        'custom_parameter_1': 'user_type',
        'custom_parameter_2': 'community_impact',
        'custom_parameter_3': 'session_id'
      }
    });
  </script>

  <!-- Meauxbility Analytics -->
  <script src="js/analytics.js"></script>
  <script src="js/events.js"></script>
  
  <style>
    /* ‚îÄ‚îÄ‚îÄ MEAUXX BRAND VARIABLES ‚îÄ‚îÄ‚îÄ */
    :root {
      --meaux-dark:  #23272B;
      --meaux-card:  #2A2A2A;
      --meaux-teal:  #1F97A9;
      --meaux-orange:#FF7619;
      --meaux-green:#21C48C;
      --white:      #FFFFFF;
      --radius:      16px;
      --font-base:  'Inter', Arial, sans-serif;
    }

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-base);
      background: var(--meaux-dark);
      color: var(--white);
      line-height: 1.5;
    }

    /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
    #current-campaign {
      padding: 4rem 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .campaign-hero {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 2rem;
      background: var(--meaux-card);
      border-radius: var(--radius);
      padding: 2.5rem;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      will-change: transform;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeIn 0.6s ease-out forwards;
    }
    .campaign-hero:hover {
      transform: translateY(-5px);
      box-shadow:
        0 10px 30px rgba(0,0,0,0.5),
        0 0 20px var(--meaux-teal);
    }

    .campaign-image {
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      aspect-ratio: 1;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    .campaign-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scale(1);
      transition: transform 0.3s ease;
      will-change: transform;
    }
    .campaign-hero:hover .campaign-image img {
      transform: scale(1.05);
    }

    .campaign-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 1rem;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,0.7));
    }
    .athlete-name {
      font-size: 1.5rem;
      font-weight: 700;
      text-shadow: 0 2px 6px rgba(0,0,0,0.7);
    }

    .campaign-details {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .campaign-title {
      font-size: clamp(1.8rem, 4vw, 2.4rem);
      font-weight: 800;
      margin-bottom: 1rem;
      position: relative;
    }
    .campaign-title::after {
      content: '';
      position: absolute;
      bottom: -0.25rem;
      left: 0;
      width: 4rem;
      height: 4px;
      background: var(--meaux-orange);
      border-radius: 2px;
    }

    .campaign-description {
      font-size: 1rem;
      color: rgba(255,255,255,0.85);
      margin-bottom: 2rem;
    }

    .campaign-progress {
      background: rgba(255,255,255,0.05);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      gap: 1rem;
    }
    .progress-info > div {
      flex: 1;
      text-align: center;
    }
    .amount {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .raised .amount { color: var(--meaux-green); }
    .goal   .amount { color: var(--meaux-orange); }
    .complete .amount { color: var(--meaux-teal); }

    .progress-bar {
      background: rgba(255,255,255,0.1);
      border-radius: var(--radius);
      overflow: hidden;
      height: 12px;
      margin-bottom: 1rem;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--meaux-green), var(--meaux-orange));
      width: 0;
      transition: width 1.5s ease-out;
      position: relative;
      box-shadow: 0 0 20px rgba(33, 196, 140, 0.3);
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .donors-count {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 1.5rem;
      font-style: italic;
    }

    /* ‚îÄ‚îÄ‚îÄ HEAD BUTTON (SEMI GLOW) ‚îÄ‚îÄ‚îÄ */
    .sponsor-btn {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(12px);
      text-shadow: 0 2px 8px rgba(0,0,0,0.8);
      color: var(--white);
      border: none;
      border-radius: var(--radius);
      padding: 1rem 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
      align-self: center;
    }
    .sponsor-btn:hover {
      background: rgba(31,151,169,0.25);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 12px 35px rgba(31,151,169,0.5);
    }
    .sponsor-btn.loading {
      opacity: 0.7;
      pointer-events: none;
    }
    .sponsor-btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 1rem;
      height: 1rem;
      margin: -0.5rem;
      border: 2px solid transparent;
      border-top-color: var(--white);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* ‚îÄ‚îÄ‚îÄ MODAL STYLES ‚îÄ‚îÄ‚îÄ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .modal.show {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background: var(--meaux-card);
      border-radius: var(--radius);
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    .modal.show .modal-content {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--white);
    }
    .close-btn {
      background: none;
      border: none;
      color: var(--white);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: background 0.3s ease;
    }
    .close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .donation-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .form-group label {
      font-weight: 600;
      color: var(--white);
    }
    .form-group input,
    .form-group select {
      padding: 0.75rem;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--white);
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--meaux-teal);
    }

    .amount-tiers {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin: 1rem 0;
    }
    .tier-btn {
      padding: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--white);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    .tier-btn:hover,
    .tier-btn.selected {
      border-color: var(--meaux-teal);
      background: rgba(31, 151, 169, 0.2);
      transform: translateY(-2px);
    }

    .custom-amount {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .custom-amount input {
      flex: 1;
    }

    .donate-btn {
      background: linear-gradient(135deg, var(--meaux-teal), var(--meaux-green));
      color: var(--white);
      border: none;
      border-radius: 8px;
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      margin-top: 1rem;
    }
    .donate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(31, 151, 169, 0.4);
    }
    .donate-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .payment-element {
      margin-top: 1rem;
      padding: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.02);
    }

    .success-message {
      text-align: center;
      padding: 2rem;
      background: rgba(33, 196, 140, 0.1);
      border: 2px solid var(--meaux-green);
      border-radius: 8px;
      margin-top: 1rem;
    }
    .success-message h3 {
      color: var(--meaux-green);
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .error-message {
      text-align: center;
      padding: 1rem;
      background: rgba(255, 118, 25, 0.1);
      border: 2px solid var(--meaux-orange);
      border-radius: 8px;
      margin-top: 1rem;
      color: var(--meaux-orange);
    }

    .email-subscription {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .email-subscription label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
    }
    .email-subscription input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    /* ‚îÄ‚îÄ‚îÄ PAYMENT METHODS ‚îÄ‚îÄ‚îÄ */
    .payment-methods {
      display: flex;
      gap: 0.75rem;
      margin: 1rem 0;
    }
    .payment-method-btn {
      flex: 1;
      padding: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--white);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    .payment-method-btn:hover,
    .payment-method-btn.active {
      border-color: var(--meaux-teal);
      background: rgba(31, 151, 169, 0.2);
      transform: translateY(-2px);
    }
    .payment-icon {
      font-size: 1.5rem;
    }

    /* ‚îÄ‚îÄ‚îÄ TRUST BADGES ‚îÄ‚îÄ‚îÄ */
    .trust-badges {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .trust-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
    }
    .badge-icon {
      font-size: 1.25rem;
      opacity: 0.8;
    }

    /* ‚îÄ‚îÄ‚îÄ KEYFRAMES & ANIMATIONS ‚îÄ‚îÄ‚îÄ */
    @keyframes fadeIn {
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 900px) {
      .campaign-hero { grid-template-columns: 1fr; text-align: center; }
      .campaign-image { max-width: 300px; margin: 0 auto; }
      .amount-tiers { grid-template-columns: 1fr; }
      .modal-content { margin: 1rem; }
    }
  </style>
</head>
<body>
  <section id="current-campaign">
    <div class="campaign-hero">
      <div class="campaign-image">
        <img src="https://cdn.shopify.com/s/files/1/0685/1654/4672/files/me-an-don-cajun-muscle-2.jpg?v=1754012437" alt="DonMichael">
        <div class="campaign-overlay">
          <div class="athlete-name">DonMichael</div>
        </div>
      </div>
      <div class="campaign-details">
        <h2 class="campaign-title">Help DonMichael Replace His Breaking Wheelchair</h2>
        <p class="campaign-description">
          DonMichael is a warrior living with Friedreich's ataxia. His current wheelchair is failing, and he needs a specialized racing wheelchair to stay competitive. Your gift unlocks his next victory.
        </p>
        <div class="campaign-progress">
          <div class="progress-info">
            <div class="raised"><span class="amount" id="raised-amount">$0</span><div class="label">raised</div></div>
            <div class="goal"><span class="amount">$10,000</span><div class="label">goal</div></div>
            <div class="complete"><span class="amount" id="complete-percentage">0%</span><div class="label">complete</div></div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" data-progress="0"></div>
          </div>
          <div class="donors-count" id="donors-count">Be the first generous donor!</div>
          <button class="sponsor-btn" id="sponsor-btn">üéØ Current Campaign</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Donation Modal -->
  <div class="modal" id="donation-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Support DonMichael's Wheelchair Fund</h3>
        <button class="close-btn" id="close-modal">&times;</button>
      </div>
      
      <form class="donation-form" id="donation-form">
        <div class="form-group">
          <label for="donor-name">Your Name</label>
          <input type="text" id="donor-name" name="donorName" required>
        </div>

        <div class="form-group">
          <label for="donor-email">Email Address</label>
          <input type="email" id="donor-email" name="donorEmail" required>
        </div>

        <div class="form-group">
          <label>Donation Amount</label>
          <div class="amount-tiers">
            <button type="button" class="tier-btn" data-amount="100">$100</button>
            <button type="button" class="tier-btn" data-amount="500">$500</button>
            <button type="button" class="tier-btn" data-amount="1000">$1,000</button>
          </div>
          <div class="custom-amount">
            <input type="number" id="custom-amount" name="customAmount" placeholder="Custom amount" min="1">
            <span>$</span>
          </div>
        </div>

        <div class="form-group">
          <label for="donation-frequency">Frequency</label>
          <select id="donation-frequency" name="frequency" required>
            <option value="one_time">One-time Donation</option>
            <option value="monthly">Monthly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>

        <div class="form-group">
          <label>Payment Method</label>
          <div class="payment-methods">
            <button type="button" class="payment-method-btn active" data-method="stripe">
              <span class="payment-icon">üí≥</span>
              <span>Card</span>
            </button>
            <button type="button" class="payment-method-btn" data-method="paypal">
              <span class="payment-icon">üÖøÔ∏è</span>
              <span>PayPal</span>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="cover-fees" name="coverFees">
            <span>Cover processing fees (+3%)</span>
          </label>
        </div>

        <div class="email-subscription">
          <label>
            <input type="checkbox" id="subscribe-email" name="subscribeEmail" checked>
            <span>Subscribe to stay inspired with DonMichael's journey and Meauxbility updates</span>
          </label>
        </div>

        <button type="submit" class="donate-btn" id="donate-btn">
          <span class="btn-text">Donate Now</span>
          <span class="btn-loading" style="display:none;">Processing...</span>
        </button>

        <!-- Trust Badges -->
        <div class="trust-badges">
          <div class="trust-badge">
            <span class="badge-icon">üîí</span>
            <span>Secured by Stripe</span>
          </div>
          <div class="trust-badge">
            <span class="badge-icon">üõ°Ô∏è</span>
            <span>PCI DSS Compliant</span>
          </div>
          <div class="trust-badge">
            <span class="badge-icon">üèõÔ∏è</span>
            <span>501(c)(3) Tax Deductible</span>
          </div>
        </div>
      </form>

      <div id="payment-element" class="payment-element" style="display:none;">
        <!-- Stripe Elements will be inserted here -->
      </div>

      <div id="success-message" class="success-message" style="display:none;">
        <h3>üéâ Thank You for Your Impact!</h3>
        <p>Your donation is helping DonMichael get closer to his new wheelchair. You'll receive a confirmation email shortly.</p>
      </div>

      <div id="error-message" class="error-message" style="display:none;">
        <!-- Error messages will be shown here -->
      </div>
    </div>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://www.paypal.com/sdk/js?client-id=Af7xJl9gu8O-eIUIGU6xzE_rpb_tAm2j76T1ZPUhcOCYlzhZ3f6Ct3gLHO5Fxo1ya5JcKcMOI5VjB9JT&currency=USD"></script>
  <script>
    // ‚úÖ PRODUCTION API CONFIGURATION - NO MORE LOCALHOST
    const API_BASE = 'https://ajhltmrehtytpzbdhepa.supabase.co/functions/v1';
    const STRIPE_PUBLISHABLE_KEY = 'pk_test_51S4R0SRW56Pm3uYIvWUGsxc2Wfz1Wo3MbyRECaDqvO0EAdSpv9qnfubDtf5ahvFypFjm6zHWZnI7SIuppKetnLgs00p3LVWTve';
    const PAYPAL_CLIENT_ID = 'Af7xJl9gu8O-eIUIGU6xzE_rpb_tAm2j76T1ZPUhcOCYlzhZ3f6Ct3gLHO5Fxo1ya5JcKcMOI5VjB9JT';
    
    // Initialize Stripe
    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

    // Campaign data - will be loaded from Supabase
    let campaignData = {
      raised: 0,
      goal: 10000,
      donors: 0
    };

    // DOM Elements
    const sponsorBtn = document.getElementById('sponsor-btn');
    const modal = document.getElementById('donation-modal');
    const closeModal = document.getElementById('close-modal');
    const donationForm = document.getElementById('donation-form');
    const tierBtns = document.querySelectorAll('.tier-btn');
    const customAmountInput = document.getElementById('custom-amount');
    const donateBtn = document.getElementById('donate-btn');
    const paymentElement = document.getElementById('payment-element');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');

    // Progress elements
    const raisedAmount = document.getElementById('raised-amount');
    const completePercentage = document.getElementById('complete-percentage');
    const progressFill = document.getElementById('progress-fill');
    const donorsCount = document.getElementById('donors-count');

    // ‚úÖ LOAD CAMPAIGN DATA FROM SUPABASE
    async function loadCampaignData() {
      try {
        const response = await fetch(`${API_BASE}/get_donation_totals_public`);
        const data = await response.json();
        
        if (data && data.length > 0) {
          const campaign = data.find(c => c.campaign_id); // Find donmichael campaign
          if (campaign) {
            campaignData.raised = campaign.total_gross_succeeded || 0;
            campaignData.donors = campaign.succeeded_count || 0;
            updateProgress();
          }
        }
      } catch (error) {
        console.log('Loading campaign data from Supabase:', error);
        // Keep default values if API fails
      }
    }

    // Modal functionality
    sponsorBtn.addEventListener('click', () => {
      modal.classList.add('show');
    });

    closeModal.addEventListener('click', () => {
      modal.classList.remove('show');
      resetForm();
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('show');
        resetForm();
      }
    });

    // Tier button selection
    tierBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        tierBtns.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        customAmountInput.value = '';
      });
    });

    // Custom amount input
    customAmountInput.addEventListener('input', () => {
      tierBtns.forEach(b => b.classList.remove('selected'));
    });

    // Payment method selection
    const paymentMethodBtns = document.querySelectorAll('.payment-method-btn');
    let selectedPaymentMethod = 'stripe';
    
    paymentMethodBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        paymentMethodBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedPaymentMethod = btn.dataset.method;
      });
    });

    // ‚úÖ FORM SUBMISSION - CONNECTED TO SUPABASE
    donationForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(donationForm);
      const selectedTier = document.querySelector('.tier-btn.selected');
      const amount = selectedTier ? 
        parseInt(selectedTier.dataset.amount) : 
        parseInt(customAmountInput.value) || 0;
      
      if (amount < 1) {
        showError('Please select or enter a donation amount.');
        return;
      }

      const donationData = {
        userId: 'donmichael_' + Date.now(),
        fund: 'donmichael',
        frequency: formData.get('frequency'),
        amount: amount,
        currency: 'usd',
        coverFees: formData.get('coverFees') === 'on',
        donorName: formData.get('donorName'),
        donorEmail: formData.get('donorEmail'),
        subscribeEmail: formData.get('subscribeEmail') === 'on'
      };
      
      try {
        donateBtn.disabled = true;
        donateBtn.querySelector('.btn-text').style.display = 'none';
        donateBtn.querySelector('.btn-loading').style.display = 'inline';
        
        // Handle PayPal payments
        if (selectedPaymentMethod === 'paypal') {
          // Create PayPal order
          const paypalOrder = await fetch(`${API_BASE}/processPayment`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              ...donationData,
              paymentMethod: 'paypal'
            })
          });
          
          const paypalResult = await paypalOrder.json();
          
          if (paypalResult.error) {
            throw new Error(paypalResult.error);
          }
          
          // Initialize PayPal buttons
          paypal.Buttons({
            createOrder: function(data, actions) {
              return actions.order.create({
                purchase_units: [{
                  amount: {
                    value: amount.toString(),
                    currency_code: 'USD'
                  },
                  description: `DonMichael Wheelchair Fund - ${donationData.frequency} donation`
                }]
              });
            },
            onApprove: function(data, actions) {
              return actions.order.capture().then(function(details) {
                // Handle successful PayPal payment
                campaignData.raised += amount;
                campaignData.donors += 1;
                updateProgress();
                
                paymentElement.style.display = 'none';
                successMessage.style.display = 'block';
                
                trackDonation(donationData);
                
                setTimeout(() => {
                  modal.classList.remove('show');
                  resetForm();
                }, 3000);
              });
            },
            onError: function(err) {
              showError('PayPal payment failed. Please try again.');
            }
          }).render('#paypal-button-container');
          
          // Show PayPal button container
          paymentElement.innerHTML = '<div id="paypal-button-container"></div>';
          paymentElement.style.display = 'block';
          donationForm.style.display = 'none';
          
          return;
        }
        
        // ‚úÖ CREATE DONATION INTENT VIA SUPABASE (Stripe)
        const response = await fetch(`${API_BASE}/processPayment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(donationData)
        });
        
        const result = await response.json();
        
        if (result.error) {
          throw new Error(result.error);
        }
        
        // Show payment element
        paymentElement.style.display = 'block';
        donationForm.style.display = 'none';
        
        // Initialize Stripe Elements
        const elements = stripe.elements({
          clientSecret: result.clientSecret
        });
        
        const paymentElementStripe = elements.create('payment');
        paymentElementStripe.mount('#payment-element');
        
        // Handle payment submission
        const {error, paymentIntent} = await stripe.confirmPayment({
          elements,
          confirmParams: {
            return_url: window.location.href,
          },
          redirect: 'if_required'
        });
        
        if (error) {
          throw new Error(error.message);
        }
        
        if (paymentIntent.status === 'succeeded') {
          // ‚úÖ HANDLE EMAIL SUBSCRIPTION VIA SUPABASE
          if (donationData.subscribeEmail) {
            try {
              await fetch(`${API_BASE}/submitApplication`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  type: 'email_subscription',
                  email: donationData.donorEmail,
                  firstName: donationData.donorName.split(' ')[0],
                  lastName: donationData.donorName.split(' ').slice(1).join(' '),
                  source: 'donation'
                })
              });
            } catch (emailError) {
              console.log('Email subscription failed:', emailError);
              // Don't fail the donation if email subscription fails
            }
          }
          
          // Update campaign data
          campaignData.raised += amount;
          campaignData.donors += 1;
          
          // Update UI
          updateProgress();
          
          // Show success message
          paymentElement.style.display = 'none';
          successMessage.style.display = 'block';
          
          // Track analytics
          trackDonation(donationData);
          
          // Auto-close modal after 3 seconds
          setTimeout(() => {
            modal.classList.remove('show');
            resetForm();
          }, 3000);
        }
        
      } catch (error) {
        console.error('Payment error:', error);
        showError(error.message);
      } finally {
        donateBtn.disabled = false;
        donateBtn.querySelector('.btn-text').style.display = 'inline';
        donateBtn.querySelector('.btn-loading').style.display = 'none';
      }
    });

    // Update progress bar and stats
    function updateProgress() {
      const percentage = Math.min((campaignData.raised / campaignData.goal) * 100, 100);
      
      // Animate progress bar
      progressFill.style.width = percentage + '%';
      progressFill.setAttribute('data-progress', percentage);
      
      // Update amounts
      raisedAmount.textContent = '$' + campaignData.raised.toLocaleString();
      completePercentage.textContent = Math.round(percentage) + '%';
      
      // Update donors count
      if (campaignData.donors === 1) {
        donorsCount.textContent = '1 generous donor!';
      } else {
        donorsCount.textContent = `${campaignData.donors} generous donors!`;
      }
    }

    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 5000);
    }

    // Reset form
    function resetForm() {
      donationForm.style.display = 'block';
      paymentElement.style.display = 'none';
      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';
      donationForm.reset();
      tierBtns.forEach(b => b.classList.remove('selected'));
    }

    // ‚úÖ TRACK DONATION ANALYTICS VIA SUPABASE
    function trackDonation(donationData) {
      fetch(`${API_BASE}/submitApplication`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          type: 'donation_analytics',
          amount: donationData.amount,
          fund: donationData.fund,
          frequency: donationData.frequency,
          timestamp: new Date().toISOString()
        })
      }).catch(err => console.log('Analytics tracking failed:', err));
    }

    // ‚úÖ REAL-TIME UPDATES FROM SUPABASE
    function checkForUpdates() {
      loadCampaignData();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Load initial campaign data
      loadCampaignData();
      
      // Initial progress animation
      const section = document.getElementById('current-campaign');
      const obs = new IntersectionObserver((entries) => {
        entries.forEach(e => {
          if (e.isIntersecting) {
            updateProgress();
            obs.unobserve(e.target);
          }
        });
      }, { threshold: 0.4 });
      obs.observe(section);

      // Parallax on Hero
      const hero = document.querySelector('.campaign-hero');
      let frame = null;
      hero?.addEventListener('mousemove', (e) => {
        if (frame) return;
        frame = requestAnimationFrame(() => {
          const rect = hero.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width - 0.5;
          const y = (e.clientY - rect.top) / rect.height - 0.5;
          const img = hero.querySelector('.campaign-image img');
          img.style.transform = `scale(1.05) translate3d(${x*10}px,${y*10}px,0)`;
          frame = null;
        });
      });
      hero?.addEventListener('mouseleave', () => {
        const img = hero.querySelector('.campaign-image img');
        img.style.transform = 'scale(1)';
      });

      // ‚úÖ REAL-TIME UPDATES EVERY 30 SECONDS
      setInterval(checkForUpdates, 30000);
    });
  </script>
</body>
</html>
